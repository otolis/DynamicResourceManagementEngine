// =============================================================================
// DRME Prisma Schema - Meta-Schema with Security-First Design
// =============================================================================
// Every tenant-scoped table MUST have tenantId column with index.
// This is enforced at the repository layer for data isolation.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// CORE SECURITY MODELS
// =============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users               User[]
  roles               Role[]
  entityTypes         EntityType[]
  accessPolicies      AccessPolicy[]
  workflowDefinitions WorkflowDefinition[]
}

model User {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email          String
  passwordHash   String
  firstName      String?
  lastName       String?
  isActive       Boolean  @default(true)
  refreshToken   String?  // Hashed refresh token for revocation
  lastLoginAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userRoles       UserRole[]
  entityInstances EntityInstance[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  displayName String
  description String?
  isSystem    Boolean  @default(false) // Prevent deletion of core roles
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions RolePermission[]
  users       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id       String @id @default(uuid())
  resource String // "entityType", "entityInstance", "workflow", "user", "role"
  action   String // "create", "read", "update", "delete", "manage"

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

// ABAC Policy Model
model AccessPolicy {
  id          String       @id @default(uuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  resource    String       // "entityInstance"
  action      String       // "create", "read", "update", "delete"
  conditions  Json         // ABAC conditions in JSON format
  effect      PolicyEffect @default(ALLOW)
  priority    Int          @default(0) // Higher = evaluated first
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId, resource, action])
}

enum PolicyEffect {
  ALLOW
  DENY
}

// =============================================================================
// META-SCHEMA MODELS
// =============================================================================

model EntityType {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String   // "project", "task", "invoice"
  displayName String   // "Project", "Task", "Invoice"
  description String?
  iconName    String?  // For UI rendering
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  attributes  Attribute[]
  instances   EntityInstance[]
  workflows   WorkflowDefinition[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Attribute {
  id              String   @id @default(uuid())
  tenantId        String
  entityTypeId    String
  entityType      EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  name            String   // "title", "dueDate", "amount"
  displayName     String   // "Title", "Due Date", "Amount"
  description     String?
  dataType        DataType
  isRequired      Boolean  @default(false)
  isUnique        Boolean  @default(false)
  isSearchable    Boolean  @default(false)
  defaultValue    Json?
  validationRules Json?    // {"min": 0, "max": 100, "pattern": "..."}
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  options AttributeOption[]
  values  AttributeValue[]

  // For RELATION type - target entity type
  relatedEntityTypeId String?

  @@unique([entityTypeId, name])
  @@index([tenantId])
}

enum DataType {
  STRING
  TEXT
  NUMBER
  DECIMAL
  DATE
  DATETIME
  BOOLEAN
  ENUM
  RELATION
  JSON
}

model AttributeOption {
  id          String    @id @default(uuid())
  attributeId String
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  value       String
  displayName String
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)

  @@unique([attributeId, value])
}

// =============================================================================
// INSTANCE DATA MODELS (EAV Pattern)
// =============================================================================

model EntityInstance {
  id           String     @id @default(uuid())
  tenantId     String
  entityTypeId String
  entityType   EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User       @relation(fields: [createdById], references: [id])
  isDeleted    Boolean    @default(false) // Soft delete
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  attributeValues  AttributeValue[]
  workflowInstance WorkflowInstance?

  @@index([tenantId])
  @@index([entityTypeId])
  @@index([tenantId, entityTypeId])
}

model AttributeValue {
  id               String         @id @default(uuid())
  tenantId         String
  entityInstanceId String
  entityInstance   EntityInstance @relation(fields: [entityInstanceId], references: [id], onDelete: Cascade)
  attributeId      String
  attribute        Attribute      @relation(fields: [attributeId], references: [id])

  // Polymorphic value storage
  stringValue  String?
  numberValue  Float?
  booleanValue Boolean?
  dateValue    DateTime?
  jsonValue    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityInstanceId, attributeId])
  @@index([tenantId])
}

// =============================================================================
// WORKFLOW MODELS
// =============================================================================

model WorkflowDefinition {
  id           String     @id @default(uuid())
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entityTypeId String
  entityType   EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  name         String
  displayName  String
  description  String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  states      WorkflowState[]
  transitions WorkflowTransition[]

  @@unique([tenantId, entityTypeId, name])
  @@index([tenantId])
}

model WorkflowState {
  id                   String             @id @default(uuid())
  workflowDefinitionId String
  workflowDefinition   WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id], onDelete: Cascade)
  name                 String             // "draft", "active", "completed"
  displayName          String
  description          String?
  color                String?            // For UI rendering
  isInitial            Boolean            @default(false)
  isFinal              Boolean            @default(false)
  sortOrder            Int                @default(0)

  // Relations
  transitionsFrom WorkflowTransition[] @relation("fromState")
  transitionsTo   WorkflowTransition[] @relation("toState")
  instances       WorkflowInstance[]

  @@unique([workflowDefinitionId, name])
}

model WorkflowTransition {
  id                   String             @id @default(uuid())
  workflowDefinitionId String
  workflowDefinition   WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id], onDelete: Cascade)
  fromStateId          String
  fromState            WorkflowState      @relation("fromState", fields: [fromStateId], references: [id], onDelete: Cascade)
  toStateId            String
  toState              WorkflowState      @relation("toState", fields: [toStateId], references: [id], onDelete: Cascade)
  name                 String             // "submit", "approve", "reject"
  displayName          String
  requiredPermission   String?            // Permission needed to execute

  @@unique([workflowDefinitionId, fromStateId, toStateId])
}

model WorkflowInstance {
  id               String         @id @default(uuid())
  tenantId         String
  entityInstanceId String         @unique
  entityInstance   EntityInstance @relation(fields: [entityInstanceId], references: [id], onDelete: Cascade)
  currentStateId   String
  currentState     WorkflowState  @relation(fields: [currentStateId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([tenantId])
}
