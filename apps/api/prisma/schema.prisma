generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                  String               @id @default(uuid())
  name                String
  slug                String               @unique
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  accessPolicies      AccessPolicy[]
  entityTypes         EntityType[]
  roles               Role[]
  users               User[]
  workflowDefinitions WorkflowDefinition[]
}

model User {
  id                  String           @id @default(uuid())
  tenantId            String
  email               String
  passwordHash        String?
  firstName           String?
  lastName            String?
  isActive            Boolean          @default(true)
  refreshToken        String?
  lastLoginAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  emailVerified       Boolean          @default(false)
  failedLoginAttempts Int              @default(0)
  lockoutUntil        DateTime?
  passwordResetExpiry DateTime?
  passwordResetToken  String?
  verificationExpiry  DateTime?
  verificationToken   String?
  githubId            String?          @unique
  googleId            String?          @unique
  entityInstances     EntityInstance[]
  tenant              Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles           UserRole[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([verificationToken])
  @@index([passwordResetToken])
}

model Role {
  id          String           @id @default(uuid())
  tenantId    String
  name        String
  displayName String
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  users       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id       String           @id @default(uuid())
  resource String
  action   String
  roles    RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model AccessPolicy {
  id          String       @id @default(uuid())
  tenantId    String
  name        String
  description String?
  resource    String
  action      String
  conditions  Json
  effect      PolicyEffect @default(ALLOW)
  priority    Int          @default(0)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId, resource, action])
}

model EntityType {
  id          String               @id @default(uuid())
  tenantId    String
  name        String
  displayName String
  description String?
  iconName    String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  attributes  Attribute[]
  instances   EntityInstance[]
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflows   WorkflowDefinition[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Attribute {
  id                  String            @id @default(uuid())
  tenantId            String
  entityTypeId        String
  name                String
  displayName         String
  description         String?
  dataType            DataType
  isRequired          Boolean           @default(false)
  isUnique            Boolean           @default(false)
  isSearchable        Boolean           @default(false)
  defaultValue        Json?
  validationRules     Json?
  sortOrder           Int               @default(0)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  relatedEntityTypeId String?
  entityType          EntityType        @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  options             AttributeOption[]
  values              AttributeValue[]

  @@unique([entityTypeId, name])
  @@index([tenantId])
}

model AttributeOption {
  id          String    @id @default(uuid())
  attributeId String
  value       String
  displayName String
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeId, value])
}

model EntityInstance {
  id               String            @id @default(uuid())
  tenantId         String
  entityTypeId     String
  createdById      String
  isDeleted        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  attributeValues  AttributeValue[]
  createdBy        User              @relation(fields: [createdById], references: [id])
  entityType       EntityType        @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  workflowInstance WorkflowInstance?

  @@index([tenantId])
  @@index([entityTypeId])
  @@index([tenantId, entityTypeId])
}

model AttributeValue {
  id               String         @id @default(uuid())
  tenantId         String
  entityInstanceId String
  attributeId      String
  stringValue      String?
  numberValue      Float?
  booleanValue     Boolean?
  dateValue        DateTime?
  jsonValue        Json?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  attribute        Attribute      @relation(fields: [attributeId], references: [id])
  entityInstance   EntityInstance @relation(fields: [entityInstanceId], references: [id], onDelete: Cascade)

  @@unique([entityInstanceId, attributeId])
  @@index([tenantId])
}

model WorkflowDefinition {
  id           String               @id @default(uuid())
  tenantId     String
  entityTypeId String
  name         String
  displayName  String
  description  String?
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  entityType   EntityType           @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  states       WorkflowState[]
  transitions  WorkflowTransition[]

  @@unique([tenantId, entityTypeId, name])
  @@index([tenantId])
}

model WorkflowState {
  id                   String               @id @default(uuid())
  workflowDefinitionId String
  name                 String
  displayName          String
  description          String?
  color                String?
  isInitial            Boolean              @default(false)
  isFinal              Boolean              @default(false)
  sortOrder            Int                  @default(0)
  instances            WorkflowInstance[]
  workflowDefinition   WorkflowDefinition   @relation(fields: [workflowDefinitionId], references: [id], onDelete: Cascade)
  transitionsFrom      WorkflowTransition[] @relation("fromState")
  transitionsTo        WorkflowTransition[] @relation("toState")

  @@unique([workflowDefinitionId, name])
}

model WorkflowTransition {
  id                   String             @id @default(uuid())
  workflowDefinitionId String
  fromStateId          String
  toStateId            String
  name                 String
  displayName          String
  requiredPermission   String?
  fromState            WorkflowState      @relation("fromState", fields: [fromStateId], references: [id], onDelete: Cascade)
  toState              WorkflowState      @relation("toState", fields: [toStateId], references: [id], onDelete: Cascade)
  workflowDefinition   WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id], onDelete: Cascade)

  @@unique([workflowDefinitionId, fromStateId, toStateId])
}

model WorkflowInstance {
  id               String         @id @default(uuid())
  tenantId         String
  entityInstanceId String         @unique
  currentStateId   String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  currentState     WorkflowState  @relation(fields: [currentStateId], references: [id])
  entityInstance   EntityInstance @relation(fields: [entityInstanceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

enum PolicyEffect {
  ALLOW
  DENY
}

enum DataType {
  STRING
  TEXT
  NUMBER
  DECIMAL
  DATE
  DATETIME
  BOOLEAN
  ENUM
  RELATION
  JSON
}
